# Hostname
hostnamectl hostname lmgateway
cat << EOF >> /etc/hosts
127.0.1.1   lmgateway lmgateway.localdomain
EOF

# Timezone
ln -fs /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime

# Enable time synchronization
echo 'NTP=169.254.169.123' >> /etc/systemd/timesyncd.conf
systemctl enable --now systemd-timesyncd

# Configure aws-cli
aws configure set default.region eu-west-1

# Configure DNF to use IPv6
echo 'ip_resolve=IPv6' >> /etc/dnf/dnf.conf

# Install and enable SSM
case "${arch}" in
  "x86_64")
    dnf install -y https://s3.dualstack.us-east-1.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm;;
  "arm64")
    dnf install -y https://s3.dualstack.us-east-1.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_arm64/amazon-ssm-agent.rpm;;
esac
systemctl enable --now amazon-ssm-agent

# Install and enable Fluent Bit for logging to New Relic
cat << 'EOF' > /etc/yum.repos.d/fluent-bit.repo
[fluent-bit]
name = Fluent Bit
baseurl = https://packages.fluentbit.io/amazonlinux/2022/$basearch/
gpgcheck=1
gpgkey=https://packages.fluentbit.io/fluentbit.key
enabled=1
EOF

dnf install -y fluent-bit

mkdir -p /etc/fluent-bit/lib /run/fluent-bit
case "${arch}" in
  "x86_64")
    aws s3 cp --endpoint-url https://s3.dualstack.eu-west-1.amazonaws.com s3://mdekort.artifacts/out_newrelic-linux-amd64-1.17.3.so /etc/fluent-bit/lib/out_newrelic.so;;
  "arm64")
    aws s3 cp --endpoint-url https://s3.dualstack.eu-west-1.amazonaws.com s3://mdekort.artifacts/out_newrelic-linux-arm64-1.17.3.so /etc/fluent-bit/lib/out_newrelic.so;;
esac

cat << EOF > /etc/fluent-bit/plugins.conf
[PLUGINS]
  Path /etc/fluent-bit/lib/out_newrelic.so
EOF

NEWRELIC_KEY="$(get_ssm_param ${newrelic_key})"

cat << EOF > /etc/fluent-bit/fluent-bit.conf
[SERVICE]
    flush            1
    daemon           Off
    log_level        info
    parsers_file     parsers.conf
    plugins_file     plugins.conf
    http_server      On
    http_listen      0.0.0.0
    http_port        2020
    storage.metrics  on

[INPUT]
    Name                systemd
    Path                /var/log/journal
    DB                  /run/fluent-bit/journal.db
    Tag                 journal.*
    Systemd_Filter      _SYSTEMD_UNIT=amazon-ssm-agent.service
    Systemd_Filter      _SYSTEMD_UNIT=fluent-bit.service
    Systemd_Filter      _SYSTEMD_UNIT=sshd.service
    Systemd_Filter      _SYSTEMD_UNIT=systemd-logind.service
    Systemd_Filter      _SYSTEMD_UNIT=wg-quick@wg0.service
    Systemd_Filter_Type Or

[FILTER]
    Name   modify
    Match  journal.*
    Copy   _HOSTNAME hostname

[OUTPUT]
    Name        newrelic
    Match       *
    endpoint    https://log-api.eu.newrelic.com/log/v1
    licenseKey  $NEWRELIC_KEY
EOF

systemctl enable --now fluent-bit

# Install extra tools
dnf install -y vim-enhanced nmap telnet dnsutils tmux ncurses-term htop git wireguard-tools

# Configure WireGuard connection
cat << EOF > /etc/systemd/network/wg0.netdev

chown root:systemd-network /etc/systemd/network/wg0.netdev
chmod 640 /etc/systemd/network/wg0.netdev

cat << EOF > /etc/systemd/network/wg0.network

networkctl reload

# Install and configure dnsmasq
dnf install -y dnsmasq

cat << EOF >> /etc/dnsmasq.d/wireguard.conf

systemctl enable --now dnsmasq

# Use custom dnsmasq as system-wide dns resolver
cat << EOF >> /etc/resolv.conf.dnsmasq
search mdekort.lan
nameserver 127.0.0.1
EOF

ln -sf /etc/resolv.conf.dnsmasq /etc/resolv.conf
